---
title: "COVID-19"
author: "Team Delta"
date: 2021-10-20
output:
  github_document:
    toc: true
---

# Project 1

## Team Check-In October 14

1.  What's your question?

    -   Is there a correlation between temperature and COVID cases?

2.  What data do you plan to use to answer this question?

    -   Hopefully NOAA R weather library data

3.  What challenges do you anticipate encountering?

    -   Difficulty with getting data to work for our purposes

    -   The weather dataset is extremely large, so operations may take significant time to run if we don't design code to account for this

    -   Determining if any trends we see are actually significant or due to coincidence or other variables (eg. cold weather around holidays)

4.  What level of complexity of the final product are you aiming for?

    -   Closer to MVP due to other commitments

5.  What figures / tables do you anticipate producing?

    -   A line plot of weather and COVID cases over time for a specific location on the same axis, maybe faceted or color-coded by different regions

    -   Scatter plot of weather comfortable-ness vs COVID cases 2 weeks later (possibly for a specific time)

    -   We don't have any specific table ideas yet

<!-- -------------------------------------------------- -->

```{r setup}
library(tidyverse)
```

# Data

<!-- -------------------------------------------------- -->

We used several different sources of data for this project.

1.  County-level population estimates ([Census Bureau](data.census.gov))
2.  County-level COVID-19 counts (New York Times)
3.  Weather data

### **Load Census Data.** Make sure the column names are `id, Geographic Area Name, Estimate!!Total, Margin of Error!!Total`.

See the README.md file for instructions to download this data from the Census Bureau website.

```{r census-data}
filename <- "./data/census.csv"

## Load the data
df_pop <- read_csv(filename, skip = 1)
df_pop %>% knitr::kable()
```

### Automated Download of NYT Data

The New York Times is publishing up-to-date data on COVID-19 on [GitHub](https://github.com/nytimes/covid-19-data).

```{r covid-data}
url_counties <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"

filename_nyt <- "./data/nyt_counties.csv"

## Download the data locally
curl::curl_download(
        url_counties,
        destfile = filename_nyt
      )

## Loads the downloaded csv
df_covid <- read_csv(filename_nyt)
```

Re-running this code will pull the most recent version of the NY Times data.

### Join COVID and Census data

Also normalize COVID Data by cases per 100k

```{r normalize-covid-data}
df_pop <- 
  df_pop %>%
  mutate("fips" = str_remove(id, "\\d+[:alpha:]+"))

df_covid <- 
  df_covid %>%
  left_join(df_pop, by = "fips")

df_covid <-
  df_covid %>%
  select(
    date,
    county,
    state,
    fips,
    cases,
    deaths,
    population = `Estimate!!Total`
  )

df_covid <-
  df_covid %>%
  mutate("cases_per100k" = (cases / population) * 100000) %>%
  mutate("deaths_per100k" = (deaths / population) * 100000) %>%
  ungroup()
```

### Weather Data

Follow instructions linked [here](https://docs.ropensci.org/rnoaa/articles/rnoaa.html)

```{r weather-data-setup}
library('rnoaa')
# Replace with your key from here: https://www.ncdc.noaa.gov/cdo-web/token
# Remember to delete your actual API key before git pushing!
# options(noaakey = "YOUR_API-KEY")
options(noaakey = "NyqQflFurAAevqdjCxMUedSgCKwybJWj")
```

```{r weather-variables}
# set some weather variables used to import data
start_date <- '2020-01-01'
end_date <- '2020-12-31'
location_id <- 'FIPS:09009'
lim <- 1000
ideal <- 22
```

```{r weather-data}

highs <- ncdc(
    datasetid='GHCND', # Daily summaries dataset
    locationid = location_id,
    #stationid='GHCND:USC00190120', # dataset:stationid, this is Amherst, MA
    datatypeid='TMAX', # can be PRCP (precipitation), TMAX, TMIN, or TAVG(sometimes)
    startdate = start_date, 
    enddate = end_date, 
    limit = lim # I think number of datapoints, but it is weird
  )
lows <- ncdc(
    datasetid='GHCND', # Daily summaries dataset
    locationid = location_id,
    #stationid='GHCND:USC00190120', # dataset:stationid, this is Amherst, MA
    datatypeid='TMIN', # can be PRCP (precipitation), TMAX, TMIN, or TAVG(sometimes)
    startdate = start_date, 
    enddate = end_date, 
    limit = lim # I think number of datapoints, but it is weird
  )
# Temperatures are in 1/10 of a degree C, so TMAX = 300 means 30 C
combine <- ncdc_combine(highs, lows)

df_weather <- combine$data
  
df_weather <- 
  df_weather %>%
  mutate(date = lubridate::ymd_hms(date)) %>% 
  pivot_wider(
    names_from = datatype,
    values_from = value
  ) %>%
  group_by(date) %>%
  mutate(
    avg = mean((TMAX + TMIN) / 2) / 10, 
    high = mean(TMAX) / 10,
    low = mean(TMIN) / 10,
    .keep = c("unused")
  )
  
df_weather <-
  df_weather[c("date", "avg", "high", "low")] %>%
  distinct()
df_weather
```

# Analyze

<!-- -------------------------------------------------- -->

Plot Weather Data

```{r}

df_weather %>%
  mutate(comfy = ideal - max(c(abs(ideal - avg), abs(ideal - high)))) %>%
  ggplot(aes(x = date)) +
  geom_point(aes(y = high), color = "red", alpha = 0.1) +
  geom_point(aes(y = low), color = "blue", alpha = 0.1) +
  geom_point(aes(y = comfy), color = "black") 

```

```{r}
df_covid %>%
  filter(state == "Connecticut" & county == "Middlesex") %>%
  mutate(delta_cases = cases_per100k - lag(cases_per100k)) %>%
  filter(delta_cases > 0) %>%
  ggplot(
    aes(date, delta_cases)
  ) +
  geom_line() +
  scale_color_discrete(name = "County") +
  theme_minimal() +
  labs(
    x = "Date",
    y = "New Cases/Day (per 100,000 persons)",
    title = "New Cases Per Day"
  )
```

```{r}
df_middlesex <-
  df_covid %>%
  filter(state == "Connecticut" & county == "Middlesex") %>%
  left_join(df_weather, by = "date")

df_middlesex %>%
  mutate(
    comfy = ideal - max(c(abs(ideal - avg), abs(ideal - high))),
    delta_cases = cases_per100k - lag(cases_per100k)
  ) %>%
  # filter(delta_cases > 0) %>%
  ggplot(aes(x = date)) +
  geom_smooth(aes(y = avg), color = "red") +
  geom_smooth(aes(y = delta_cases)) +
  # xlim("2020-03-18", "2020-10-18") +
  scale_y_continuous(
    name = "Temperature (C)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~.*10, name="Cases/day (avg)")
  )
```
